
## Benchmark Results: Quickwit vs. Loki

## Objectives

This benchmark aims to highlight the differences and trade-offs between Quickwit and Loki for their users. Despite both log engines employing a decoupled compute and storage architecture, they use distinct data structures for querying data:
- Quickwit has an inverted index and columnar storage optimized for analytics.
- Loki has labels to categorize data into distinct streams, simplifying data access without an inverted index.

Each system has unique advantages and drawbacks; Quickwit's complex data structures enhance search speeds but increase CPU usage during data ingestion. This report highlights these differences.

## Dataset

The dataset for this benchmark was generated by the Elastic Integration Corpus Generator Tool, it is available at `gs://quickwit-datasets-public/benchmarks/generated-logs/generated-logs-v1-*`. We used the first 200 files, totalling 243,527,673 logs representing 212.40 GB. The logs are structured as JSON documents, as shown in this [example](tracks/generated-logs-for-loki/log_example.json).

The dataset can be downloaded with the following command:

```bash
gcloud storage cp "gs://quickwit-datasets-public/benchmarks/generated-logs/generated-logs-v1-{0..200}.ndjson.gz" datasets/
```

## Metrics
### Ingestion Metrics
We compared the following metrics during data ingestion:
- Ingestion time
- Total CPU time utilized
- Size of the index created
- Number of files stored on object storage

### Query Benchmarks
We focused on query types commonly used in the Grafana Explore view:
- Fetching the last 100 logs
- Analyzing log volume by log level

The following table illustrates the query configurations tested:

| Query   |   Last 100 logs   | Log volume per log level   |
|----------|----------|------------|
| Match all logs | [ ]   | [x] |
| Logs containing `queen` | [x]   | [x] |
| Logs labeled `region: us-east-2` | [x] | [x] |
| Logs with `region: us-east-2` and `queen` | [x] | [x] |

Metrics recorded for each query include latency, CPU time, and the number of GET requests on the object storage.

## Setup
### Object storage
We used Google Cloud Storage (GCS).

### Caching
All caching mechanisms within Quickwit and Loki were disabled to ensure a fair comparison.

### Loki setup
Loki 2.9 was used.

Loki was configured with labels for region and log levels, creating up to 100 distinct streams. Configurations are detailed in the [Loki configuration file](engines/loki/loki_gcs.yaml). Vector was used to route logs to Loki.

### Quickwit setup
Quickwit latest build was used, it should be more or less the same than 0.8.1.

## Results

### Ingestion

| Engine   |   Loki   | Quickwit   |
|----------|----------|------------|
| Ingest time | 55 min   | 123 min (+123%) |
| Mean vCPU | 2.75 | 2.2 |
| Total CPU time | ~151 min | ~270 min (+78%) |
| Number of files on GCS | 145,756 (x5829) | 25 |
| Bucket size | 55 GiB | 53 GiB |

## Queries

### Query last 100 logs

<table>
    <thead>
        <tr>
            <th></th>
            <th colspan="2">Latency</th>
            <th colspan="2">CPU Time (s)</th>
            <th colspan="2">Get Requests</th>
        </tr>
        <tr>
            <th>Query \ Engine</th>
            <th>Loki</th>
            <th>Quickwit</th>
            <th>Loki</th>
            <th>Quickwit</th>
            <th>Loki</th>
            <th>Quickwit</th>
        </tr>
    </thead>
    <tbody>
    <tr>
        <td>Logs containing `queen`</td>
        <td>9.3 (+1425%)</td>
        <td>0.6</td>
        <td>165 (+6000%)</td>
        <td>2.7</td>
        <td>17,655 (+8400%)</td>
        <td>206</td>
    </tr>
    <tr>
        <td>Logs containing `us-east-2` (label)</td>
        <td>1.0 (+74%)</td>
        <td>0.6</td>
        <td>2.1</td>
        <td>2.8 (+30%)</td>
        <td>85</td>
        <td>203 (+138%)</td>
    </tr>
    <tr>
        <td>Logs containing `us-east-2` (label) and `queen`</td>
        <td>0.98 (+60%)</td>
        <td>0.6</td>
        <td>15 (+435%)</td>
        <td>2.8</td>
        <td>661 (+159%)</td>
        <td>255</td>
    </tr>
    </tbody>
</table>


### Query log volume by level

<table>
    <thead>
        <tr>
            <th></th>
            <th colspan="2">Latency</th>
            <th colspan="2">CPU Time (s)</th>
            <th colspan="2">Get Requests</th>
        </tr>
        <tr>
            <th>Query \ Engine</th>
            <th>Loki</th>
            <th>Quickwit</th>
            <th>Loki</th>
            <th>Quickwit</th>
            <th>Loki</th>
            <th>Quickwit</th>
        </tr>
    </thead>
    <tbody>
    <tr>
        <td>Log volume on all dataset</td>
        <td>85 (x39)</td>
        <td>2.1</td>
        <td>1151 (x50)</td>
        <td>22.3</td>
        <td>204,808 (x2300)</td>
        <td>88</td>
    </tr>
    <tr>
        <td>Log volume containing `queen`</td>
        <td>560.0</td>
        <td>0.4 (x1399)</td>
        <td>8688 (x2713)</td>
        <td>3.2</td>
        <td>203,910 (x1386)</td>
        <td>147</td>
    </tr>
    <tr>
        <td>Log volume containing `us-east-2` (label)</td>
        <td>4.1 (+580%)</td>
        <td>0.6</td>
        <td>41 (x13)</td>
        <td>2.85</td>
        <td>6,180</td>
        <td>146 (x41)</td>
    </tr>
    <tr>
        <td>Log volume containing `us-east-2` (label) and `queen`</td>
        <td>27 (x53)</td>
        <td>0.5</td>
        <td>337 (x115)</td>
        <td>2.93</td>
        <td>5,471 (x27)</td>
        <td>195</td>
    </tr>
    </tbody>
</table>

## Reproducing the benchmark

Coming soon!

### Command to get the number of files stored by Loki

```
gsutil ls -lR gs://bench20240414-loki-2-9-6--100streams | tail -n 1
TOTAL: 145756 objects, 55137804027 bytes (51.35 GiB)
```

